name: üöÄ Automated Release & Publish

# This workflow automatically creates releases when:
# 1. package.json is modified on main branch
# 2. Version number has increased (semantic version comparison)
# No commit message keywords required - fully automatic!

on:
  push:
    branches: [ main ]
    paths:
      - 'package.json'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  id-token: write

jobs:
  check-version:
    name: üîç Check Version Change
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.version-check.outputs.changed }}
      new-version: ${{ steps.version-check.outputs.version }}
      should-release: ${{ steps.version-check.outputs.should-release }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üîç Check version change
        id: version-check
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current-version=${CURRENT_VERSION}"
          echo "version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          
          # Check if this is a manual trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger - checking for existing release"
            if gh release view "v${CURRENT_VERSION}" >/dev/null 2>&1; then
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "should-release=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Release v${CURRENT_VERSION} already exists"
            else
              echo "changed=true" >> $GITHUB_OUTPUT
              echo "should-release=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Manual release for v${CURRENT_VERSION}"
            fi
            exit 0
          fi
          
          # For push events, check if version actually changed
          if git diff HEAD~1 HEAD --name-only | grep -q "package.json"; then
            PREV_VERSION=$(git show HEAD~1:package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version")
            echo "previous-version=${PREV_VERSION}"
            
            if [ "${CURRENT_VERSION}" != "${PREV_VERSION}" ]; then
              # Version changed - check if it's a valid increase
              echo "üîç Comparing versions: ${PREV_VERSION} ‚Üí ${CURRENT_VERSION}"
              
              # Use node to compare semantic versions (simple comparison without external deps)
              VERSION_INCREASED=$(node -e "
                const current = '${CURRENT_VERSION}';
                const previous = '${PREV_VERSION}';
                
                // Simple semantic version comparison
                function compareVersions(a, b) {
                  const aParts = a.split('.').map(Number);
                  const bParts = b.split('.').map(Number);
                  
                  for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                    const aPart = aParts[i] || 0;
                    const bPart = bParts[i] || 0;
                    
                    if (aPart > bPart) return 1;
                    if (aPart < bPart) return -1;
                  }
                  return 0;
                }
                
                console.log(compareVersions(current, previous) > 0 ? 'true' : 'false');
              " 2>/dev/null || echo "false")
              
              if [ "${VERSION_INCREASED}" = "true" ]; then
                echo "changed=true" >> $GITHUB_OUTPUT
                echo "should-release=true" >> $GITHUB_OUTPUT
                echo "‚úÖ Version increased from ${PREV_VERSION} to ${CURRENT_VERSION} - auto-releasing"
              else
                echo "changed=false" >> $GITHUB_OUTPUT
                echo "should-release=false" >> $GITHUB_OUTPUT
                echo "‚ö†Ô∏è Version changed but not increased (${PREV_VERSION} ‚Üí ${CURRENT_VERSION}) - skipping release"
              fi
            else
              echo "changed=false" >> $GITHUB_OUTPUT
              echo "should-release=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No version change detected"
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è package.json not modified"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: üéØ Create Release
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true'
    outputs:
      release-created: ${{ steps.create-release.outputs.created }}
      release-url: ${{ steps.create-release.outputs.url }}
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Create and push tag
        id: create-tag
        run: |
          VERSION="v${{ needs.check-version.outputs.new-version }}"
          
          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag $VERSION already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            # Configure git
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            # Create and push tag
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
            echo "‚úÖ Created and pushed tag $VERSION"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: üìù Generate release notes
        id: release-notes
        run: |
          VERSION="v${{ needs.check-version.outputs.new-version }}"
          
          # Generate changelog since last release
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "$VERSION" ]; then
            echo "## üöÄ What's Changed" >> release_notes.md
            echo "" >> release_notes.md
            
            # Get commits since last tag
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
            
            # Add contributors
            echo "## üë• Contributors" >> release_notes.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- @%an" --no-merges | sort -u >> release_notes.md
            echo "" >> release_notes.md
          else
            echo "## üöÄ Release Notes" >> release_notes.md
            echo "" >> release_notes.md
            echo "This release includes improvements and bug fixes." >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "## üì¶ Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "npm install -g neemee-mcp-server@${{ needs.check-version.outputs.new-version }}" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${VERSION}" >> release_notes.md

      - name: üéÅ Create GitHub Release
        id: create-release
        run: |
          VERSION="v${{ needs.check-version.outputs.new-version }}"
          
          # Check if release already exists
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Release $VERSION already exists"
            RELEASE_URL=$(gh release view "$VERSION" --json url --jq '.url')
            echo "created=false" >> $GITHUB_OUTPUT
            echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
          else
            # Create release
            RELEASE_URL=$(gh release create "$VERSION" \
              --title "üöÄ Release $VERSION" \
              --notes-file release_notes.md \
              --latest)
            
            echo "‚úÖ Created GitHub release: $RELEASE_URL"
            echo "created=true" >> $GITHUB_OUTPUT
            echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: üì¶ Publish to NPM
    runs-on: ubuntu-latest
    needs: [check-version, release]
    if: needs.release.outputs.release-created == 'true'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build project
        run: npm run build

      - name: üß™ Run tests
        run: |
          # Run validation tests
          if [ -f "test/json-rpc-validation.js" ]; then
            echo "üß™ Running JSON-RPC validation tests"
            node test/json-rpc-validation.js
          fi
          
          # Run any other tests
          if npm run test >/dev/null 2>&1; then
            echo "üß™ Running npm test suite"
            npm test
          else
            echo "‚ÑπÔ∏è No npm test script found, skipping"
          fi

      - name: üîç Pre-publish validation
        run: |
          # Validate package.json
          echo "üìã Validating package.json..."
          node -e "
            const pkg = require('./package.json');
            if (!pkg.name) throw new Error('Missing package name');
            if (!pkg.version) throw new Error('Missing package version');
            if (!pkg.main) throw new Error('Missing main entry point');
            if (!require('fs').existsSync(pkg.main)) throw new Error('Main file does not exist: ' + pkg.main);
            console.log('‚úÖ Package validation passed');
          "
          
          # Check if version already published
          VERSION="${{ needs.check-version.outputs.new-version }}"
          if npm view neemee-mcp-server@${VERSION} >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Version ${VERSION} already published to npm"
            exit 1
          fi

      - name: üöÄ Publish to NPM
        run: |
          echo "üöÄ Publishing neemee-mcp-server@${{ needs.check-version.outputs.new-version }} to NPM..."
          npm publish --access public
          echo "‚úÖ Successfully published to NPM!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: üì± Update release with NPM info
        run: |
          VERSION="v${{ needs.check-version.outputs.new-version }}"
          
          # Add NPM installation info to release
          gh release edit "$VERSION" --notes-file - << 'EOF'
          ## üöÄ What's Changed
          
          This release has been automatically published to NPM!
          
          ## üì¶ Installation
          
          ```bash
          # Install globally
          npm install -g neemee-mcp-server@${{ needs.check-version.outputs.new-version }}
          
          # Or use npx
          npx neemee-mcp-server
          ```
          
          ## üîó Links
          - üì¶ [NPM Package](https://www.npmjs.com/package/neemee-mcp-server/v/${{ needs.check-version.outputs.new-version }})
          - üìñ [GitHub Repository](https://github.com/${{ github.repository }})
          - üêõ [Report Issues](https://github.com/${{ github.repository }}/issues)
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}
          EOF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-mcp:
    name: üì° Publish to MCP Registry
    runs-on: ubuntu-latest
    needs: [check-version, release, publish-npm]
    if: needs.publish-npm.result == 'success'
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Install mcp-publisher
        run: |
          # Install mcp-publisher CLI
          curl -fsSL https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher-linux-x64 -o mcp-publisher
          chmod +x mcp-publisher
          sudo mv mcp-publisher /usr/local/bin/

      - name: üîê Authenticate with GitHub
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | mcp-publisher login github --token-stdin

      - name: üöÄ Publish to MCP Registry
        run: |
          echo "üöÄ Publishing to MCP Registry..."
          mcp-publisher publish
          echo "‚úÖ Successfully published to MCP Registry!"

      - name: üì± Update release with MCP info
        run: |
          VERSION="v${{ needs.check-version.outputs.new-version }}"

          # Get current release notes and append MCP info
          gh release view "$VERSION" --json body --jq '.body' > current_notes.md

          echo "" >> current_notes.md
          echo "## üîó MCP Registry" >> current_notes.md
          echo "" >> current_notes.md
          echo "This server is now available in the Model Context Protocol Registry!" >> current_notes.md
          echo "- üì° [View on MCP Registry](https://registry.modelcontextprotocol.io/servers/io.github.pbonneville/neemee-mcp)" >> current_notes.md

          gh release edit "$VERSION" --notes-file current_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: üì¢ Notify Success
    runs-on: ubuntu-latest
    needs: [check-version, release, publish-npm, publish-mcp]
    if: always() && needs.release.outputs.release-created == 'true'
    steps:
      - name: üéâ Success Summary
        run: |
          echo "## üéâ Release Success Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Completed Actions:" >> $GITHUB_STEP_SUMMARY
          echo "- üè∑Ô∏è Created git tag: v${{ needs.check-version.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- üéÅ Created GitHub release: [${{ needs.release.outputs.release-url }}](${{ needs.release.outputs.release-url }})" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.publish-npm.result }}" = "success" ]; then
            echo "- üì¶ Published to NPM: [neemee-mcp-server@${{ needs.check-version.outputs.new-version }}](https://www.npmjs.com/package/neemee-mcp-server/v/${{ needs.check-version.outputs.new-version }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è NPM publish failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.publish-mcp.result }}" = "success" ]; then
            echo "- üì° Published to MCP Registry: [io.github.pbonneville/neemee-mcp](https://registry.modelcontextprotocol.io/servers/io.github.pbonneville/neemee-mcp)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚ö†Ô∏è MCP Registry publish failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Ready for use!" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npm install -g neemee-mcp-server@${{ needs.check-version.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY